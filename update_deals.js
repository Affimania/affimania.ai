const fs = require('fs');
const path = require('path');
const amazonPaapi = require('amazon-paapi');

// üîê Your Credentials (Directly using for fix)
const ACCESS_KEY = 'AKPALTMLPD1766576649'; 
const SECRET_KEY = 'jC7vaQ1o9PGlVMcTC8Uu/RCUeSWuA8w60Sn2rX7z';
const PARTNER_TAG = 'ascreation00f-21';

async function updateDeals() {
    let finalDeals = [];
    
    try {
        console.log("Attempting to fetch from Amazon PA-API...");
        const commonParameters = {
            'AccessKey': ACCESS_KEY, 'SecretKey': SECRET_KEY,
            'PartnerTag': PARTNER_TAG, 'PartnerType': 'Associates', 'Marketplace': 'www.amazon.in'
        };
        const requestParameters = {
            'Keywords': 'Smartwatch Headphones Laptop SmartHome',
            'SearchIndex': 'All', 'ItemCount': 10,
            'Resources': ['ItemInfo.Title', 'Offers.Listings.Price', 'Images.Primary.Large', 'Offers.Listings.SavingBasis']
        };

        const data = await amazonPaapi.SearchItems(commonParameters, requestParameters);
        const items = data.SearchResult.Items;

        items.forEach(item => {
            const priceInfo = item.Offers.Listings[0];
            finalDeals.push({
                title: item.ItemInfo.Title.DisplayValue,
                price: priceInfo.Price.Amount.toLocaleString('en-IN'),
                mrp: priceInfo.SavingBasis ? priceInfo.SavingBasis.Amount.toLocaleString('en-IN') : (priceInfo.Price.Amount * 1.3).toLocaleString('en-IN'),
                savings: `FLAT ${priceInfo.Price.Savings ? priceInfo.Price.Savings.Percentage : 25}% OFF`,
                affiliate_link: item.DetailPageURL,
                image: item.Images.Primary.Large.URL
            });
        });
    } catch (err) {
        console.log("‚ö†Ô∏è PA-API Error or Limit Reached. Using AI Fallback Data...");
        // Fallback for 40 Deals (4x10 Grid)
        const categories = ["Gadgets", "Tech", "SmartHome", "Style"];
        for (let i = 1; i <= 40; i++) {
            const cat = categories[Math.floor(Math.random() * categories.length)];
            const price = Math.floor(Math.random() * 5000) + 999;
            finalDeals.push({
                title: `AI Optimized ${cat} Best Seller - New Year Deal #${i}`,
                price: price.toLocaleString('en-IN'),
                mrp: (price * 1.5).toLocaleString('en-IN'),
                savings: `FLAT 33% OFF`,
                affiliate_link: `https://www.amazon.in/s?k=${cat}&tag=${PARTNER_TAG}`,
                image: `https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=500&q=80` // Premium Placeholder
            });
        }
    }

    // Ensure 40 deals
    while(finalDeals.length < 40) {
        finalDeals.push(finalDeals[0]);
    }
    finalDeals = finalDeals.slice(0, 40);

    const indexPath = path.join(__dirname, 'index.html');
    let content = fs.readFileSync(indexPath, 'utf8');
    
    // Exact Marker Update
    const startTag = "// --- START: AUTOGENERATED DEALS DATA ---";
    const endTag = "// --- END: AUTOGENERATED DEALS DATA ---";
    const replaceStr = `${startTag}\nconst dummyDeals = ${JSON.stringify(finalDeals, null, 4)};\n${endTag}`;
    
    content = content.replace(/(\/\/ --- START: AUTOGENERATED DEALS DATA ---)[\s\S]*?(\/\/ --- END: AUTOGENERATED DEALS DATA ---)/, replaceStr);
    
    fs.writeFileSync(indexPath, content);
    console.log('üöÄ Success: index.html updated with 40 Deals!');
}

updateDeals();
